---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Section from "@/components/ui/Section.astro";
import Button from "@/components/ui/Button.astro";
import ProductVariantPicker from "@/features/product/ProductVariantPicker";
import ProductGallery from "@/features/product/ProductGallery";
import { container } from "@/container";
import { SITE } from "@/shared/config/site";
import { buildWhatsAppLink } from "@/shared/lib/whatsapp";
import BackgroundDecorations from "@/components/ui/BackgroundDecorations.astro";
import ScrollIndicator from "@/components/ui/ScrollIndicator.astro";

export async function getStaticPaths() {
  const products = await container.productRepository.getAll();
  return products.map((p) => ({
    params: { slug: p.slug },
    props: { product: p },
  }));
}

const { product } = Astro.props;

if (!product) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

const relatedProducts = await container.productRepository.getRelated(product.slug);

const { Content } = product.render ? await product.render() : { Content: () => null };

const title = product.seoTitle ?? product.title;
const description = product.seoDescription ?? product.summary;
const pageTitle = `${title} | ${SITE.name}`;

const baseMessage =
  product.whatsappMessage ?? `Olá! Gostaria de um orçamento para: ${product.title}`;
const whatsappHref = buildWhatsAppLink(baseMessage);
---

<BaseLayout
  title={pageTitle}
  description={description}
  canonicalPath={`${import.meta.env.BASE_URL}catalogo/${product.slug}`}
  image={product.coverImage}
>
  <Section class="relative z-0 overflow-hidden pt-24 md:pt-32">
    <BackgroundDecorations />
    <nav class="flex items-center text-sm text-black/60">
      <a href={import.meta.env.BASE_URL} class="hover:text-[var(--cn-ink)]">Início</a>
      <span class="mx-2">/</span>
      <a href={`${import.meta.env.BASE_URL}catalogo`} class="hover:text-[var(--cn-ink)]">Catálogo</a
      >
      <span class="mx-2">/</span>
      <span class="text-[var(--cn-ink)] font-medium truncate max-w-[200px]">{product.title}</span>
    </nav>

    <div class="mt-8 grid gap-12 lg:grid-cols-2">
      <div>
        <ProductGallery
          client:load
          images={[product.coverImage, ...(product.images || [])].filter(
            (img): img is string => !!img,
          )}
          title={product.title}
        />
      </div>

      <div>
        <h1 class="text-3xl font-bold tracking-tight text-[var(--cn-ink)] md:text-4xl">
          {product.title}
        </h1>
        <div class="mt-4 text-lg text-black/70">
          {product.summary}
        </div>

        <div class="mt-8">
          <ProductVariantPicker
            client:load
            productTitle={product.title}
            options={product.options}
            baseMessageTemplate={product.whatsappMessage}
          />
        </div>

        {
          product.observations && product.observations.length > 0 && (
            <div class="mt-10 border-t border-black/8 pt-6">
              <p class="text-[10px] font-semibold uppercase tracking-[0.18em] text-black/35 mb-3">
                Observações
              </p>
              <ul class="space-y-2">
                {product.observations.map((obs) => (
                  <li class="flex items-baseline gap-2.5 text-sm text-black/60 leading-relaxed">
                    <span
                      class="shrink-0 text-[var(--cn-terracotta)] opacity-60"
                      aria-hidden="true"
                    >
                      —
                    </span>
                    {obs}
                  </li>
                ))}
              </ul>
              {product.pricingNote && (
                <p class="mt-4 text-[11px] italic text-black/35">{product.pricingNote}</p>
              )}
            </div>
          )
        }

        {
          Content && (
            <div class="mt-10 border-t border-black/8 pt-6 text-sm text-black/60 leading-relaxed [&_h1]:hidden [&_h2]:hidden [&_h3]:hidden [&_p]:mt-0 [&_p+p]:mt-2 [&_a]:text-[var(--cn-terracotta)] [&_a:hover]:underline [&_strong]:text-black/70 [&_strong]:font-medium">
              <p class="text-[10px] font-semibold uppercase tracking-[0.18em] text-black/35 mb-3">
                Sobre o produto
              </p>
              <Content />
            </div>
          )
        }
      </div>
    </div>

    <ScrollIndicator />
  </Section>

  {
    relatedProducts.length > 0 && (
      <Section theme="white" class="border-t border-black/5">
        <h2 class="text-xl font-semibold text-[var(--cn-ink)]">Veja também</h2>
        <div class="mt-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {relatedProducts.map((p) => (
            <a
              href={`${import.meta.env.BASE_URL}catalogo/${p.slug}`}
              class="group rounded-xl border border-black/5 bg-white p-4 transition-colors hover:border-[var(--cn-ink)]/20"
            >
              <div class="aspect-[4/3] overflow-hidden rounded-lg bg-[var(--cn-cream)] mb-4">
                {p.coverImage && (
                  <img
                    src={
                      p.coverImage?.startsWith("/")
                        ? `${import.meta.env.BASE_URL.replace(/\/$/, "")}/${p.coverImage.slice(1)}`
                        : p.coverImage
                    }
                    alt={p.title}
                    class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                )}
              </div>
              <h3 class="font-medium text-[var(--cn-ink)]">{p.title}</h3>
              <p class="text-sm text-black/60 truncate">{p.summary}</p>
            </a>
          ))}
        </div>
      </Section>
    )
  }
</BaseLayout>
