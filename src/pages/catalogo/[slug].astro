---
import BaseLayout from "@/layouts/BaseLayout.astro";
import ProductVariantPicker from "@/features/product/ProductVariantPicker";
import { getCollection } from "astro:content";
import { buildWhatsAppLink } from "@/shared/lib/whatsapp";

export async function getStaticPaths() {
  const products = await getCollection("products");
  return products.map((p) => ({
    params: { slug: p.slug },
    props: { product: p },
  }));
}

const { product } = Astro.props;

const title = product.data.seoTitle ?? product.data.title;
const description = product.data.seoDescription ?? product.data.summary;

function applyTemplate(template: string, vars: Record<string, string>) {
  return template.replace(/\{\{(\w+)\}\}/g, (_, key) => vars[key] ?? "");
}

const baseMessage =
  product.data.whatsappMessage ?? `Olá! Quero orçamento de ${product.data.title}.`;

const whatsappHref = buildWhatsAppLink(applyTemplate(baseMessage, {}));

const { Content } = await product.render();
---

<BaseLayout title={title} description={description} canonicalPath={`/catalogo/${product.slug}`}>
  <a class="text-sm text-black/60 hover:text-[var(--cn-ink)]" href="/catalogo"
    >← Voltar ao catálogo</a
  >

  <h1 class="mt-4 text-3xl font-semibold tracking-tight text-[var(--cn-ink)] md:text-4xl">
    {product.data.title}
  </h1>
  <p class="mt-3 max-w-2xl text-black/70">{product.data.summary}</p>

  <div class="mt-6 flex flex-wrap gap-3">
    <a
      class="rounded-xl bg-[var(--cn-ink)] px-5 py-3 text-sm font-medium text-[var(--cn-cream)] hover:bg-black/80"
      href={whatsappHref}
      target="_blank"
      rel="noreferrer"
    >
      Pedir orçamento no WhatsApp
    </a>
  </div>

  <ProductVariantPicker
    client:load
    productTitle={product.data.title}
    options={product.data.options}
    baseMessageTemplate={product.data.whatsappMessage}
  />

  <article class="prose prose-zinc mt-12 max-w-none">
    <Content />
  </article>
</BaseLayout>
