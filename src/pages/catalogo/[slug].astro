---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Section from "@/components/ui/Section.astro";
import Button from "@/components/ui/Button.astro";
import ProductVariantPicker from "@/features/product/ProductVariantPicker";
import ProductGallery from "@/features/product/ProductGallery";
import { container } from "@/container";
import { SITE } from "@/shared/config/site";
import { buildWhatsAppLink } from "@/shared/lib/whatsapp";
import BackgroundDecorations from "@/components/ui/BackgroundDecorations.astro";
import ScrollIndicator from "@/components/ui/ScrollIndicator.astro";

export async function getStaticPaths() {
  const products = await container.productRepository.getAll();
  return products.map((p) => ({
    params: { slug: p.slug },
    props: { product: p },
  }));
}

const { product } = Astro.props;

if (!product) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

const relatedProducts = await container.productRepository.getRelated(product.slug);

const { Content } = product.render ? await product.render() : { Content: () => null };

const title = product.seoTitle ?? product.title;
const description = product.seoDescription ?? product.summary;
const pageTitle = `${title} | ${SITE.name}`;

const baseMessage =
  product.whatsappMessage ?? `Olá! Gostaria de um orçamento para: ${product.title}`;
const whatsappHref = buildWhatsAppLink(baseMessage);
---

<BaseLayout
  title={pageTitle}
  description={description}
  canonicalPath={`/catalogo/${product.slug}`}
  image={product.coverImage}
>
  <Section class="relative z-0 overflow-hidden pt-24 md:pt-32">
    <BackgroundDecorations />
    <nav class="flex items-center text-sm text-black/60">
      <a href="/" class="hover:text-[var(--cn-ink)]">Início</a>
      <span class="mx-2">/</span>
      <a href="/catalogo" class="hover:text-[var(--cn-ink)]">Catálogo</a>
      <span class="mx-2">/</span>
      <span class="text-[var(--cn-ink)] font-medium truncate max-w-[200px]">{product.title}</span>
    </nav>

    <div class="mt-8 grid gap-12 lg:grid-cols-2">
      <div>
        <ProductGallery
          client:load
          images={[product.coverImage, ...(product.images || [])].filter(
            (img): img is string => !!img,
          )}
          title={product.title}
        />
      </div>

      <div>
        <h1 class="text-3xl font-bold tracking-tight text-[var(--cn-ink)] md:text-4xl">
          {product.title}
        </h1>
        <div class="mt-4 text-lg text-black/70">
          {product.summary}
        </div>

        <div class="mt-8">
          <ProductVariantPicker
            client:load
            productTitle={product.title}
            options={product.options}
            baseMessageTemplate={product.whatsappMessage}
          />
        </div>

        <article
          class="prose prose-zinc prose-headings:font-semibold prose-headings:text-[var(--cn-ink)] prose-a:text-[var(--cn-terracotta)] mt-12 max-w-none"
        >
          {Content && <Content />}
        </article>
      </div>
    </div>

    <ScrollIndicator />
  </Section>

  {
    relatedProducts.length > 0 && (
      <Section theme="white" class="border-t border-black/5">
        <h2 class="text-xl font-semibold text-[var(--cn-ink)]">Veja também</h2>
        <div class="mt-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {relatedProducts.map((p) => (
            <a
              href={`/catalogo/${p.slug}`}
              class="group rounded-xl border border-black/5 bg-white p-4 transition-colors hover:border-[var(--cn-ink)]/20"
            >
              <div class="aspect-[4/3] overflow-hidden rounded-lg bg-[var(--cn-cream)] mb-4">
                {p.coverImage && (
                  <img
                    src={p.coverImage}
                    alt={p.title}
                    class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                )}
              </div>
              <h3 class="font-medium text-[var(--cn-ink)]">{p.title}</h3>
              <p class="text-sm text-black/60 truncate">{p.summary}</p>
            </a>
          ))}
        </div>
      </Section>
    )
  }
</BaseLayout>
